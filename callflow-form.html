<em><!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Call Flow Setup | eTech</title>

  <style>
    :root{
      --bg:#f6f8fb;
      --panel:#ffffff;
      --panel2:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --line:#e2e8f0;
      --brand:#0ea5a6;
      --brand2:#2563eb;
      --ok:#16a34a;
      --warn:#d97706;
      --danger:#e11d48;
      --shadow:0 18px 45px rgba(2,6,23,.10);
      --radius:18px;
      --max:1200px;
      --font:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:var(--bg);
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:28px 16px 60px;
    }

    .wrap{ width:min(var(--max),100%); }

    header{ margin-bottom:18px; }
    .kicker{ font-size:13px; letter-spacing:.12em; text-transform:uppercase; color:var(--muted); }
    h1{ margin:8px 0 0; font-size:clamp(22px,3vw,32px); line-height:1.15; letter-spacing:-0.02em; }

    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .topbar{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background:var(--panel2);
    }

    .progress{
      flex:1;
      height:10px;
      border-radius:999px;
      background:#eef2f7;
      overflow:hidden;
      border:1px solid var(--line);
    }
    .progress > div{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,var(--brand),var(--brand2));
      border-radius:999px;
      transition:width .25s ease;
    }

    .stepcount{ font-size:13px; color:var(--muted); white-space:nowrap; }

    .body{ padding:18px 16px 16px; }

    .q{ display:none; animation:fadeUp .18s ease-out; }
    .q.active{ display:block; }

    @keyframes fadeUp{ from{ opacity:0; transform:translateY(6px);} to{ opacity:1; transform:translateY(0);} }

    .q h2{ margin:0 0 6px; font-size:18px; letter-spacing:-0.01em; }
    .q p{ margin:0 0 14px; color:var(--muted); line-height:1.45; }

    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:860px){ .grid{ grid-template-columns:1fr; } }

    label{ display:block; font-size:13px; color:var(--muted); margin:0 0 6px; }

    input[type="text"], input[type="tel"], textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#ffffff;
      color:var(--text);
      outline:none;
    }

    textarea{ min-height:110px; resize:vertical; }
    input::placeholder, textarea::placeholder{ color:#94a3b8; }

    .choices{ display:flex; flex-direction:column; gap:10px; }

    .choice{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#ffffff;
      cursor:pointer;
    }
    .choice:hover{ background:#f8fafc; }
    .choice input{ margin-top:3px; }
    .choice .ctitle{ font-weight:650; margin:0 0 2px; color:var(--text); }
    .choice .csub{ margin:0; color:var(--muted); font-size:13px; line-height:1.35; }

    .actions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-top:16px;
      padding-top:14px;
      border-top:1px solid var(--line);
    }

    button{
      border:0;
      border-radius:999px;
      padding:11px 16px;
      cursor:pointer;
      font-weight:650;
      letter-spacing:.01em;
      user-select:none;
    }

    .btn{
      background:#ffffff;
      color:var(--text);
      border:1px solid var(--line);
    }
    .btn:hover{ background:#f8fafc; }

    .btn-primary{
      background:linear-gradient(90deg,var(--brand),var(--brand2));
      color:#ffffff;
      border:1px solid rgba(15,23,42,.08);
    }
    .btn-primary:hover{ filter:brightness(1.02); }

    .hint{ font-size:12px; color:var(--muted); line-height:1.35; }
    .hidden{ display:none !important; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#f8fafc;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }

    .days{ display:flex; flex-wrap:wrap; gap:10px; }
    .day{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#ffffff;
      cursor:pointer;
    }
    .day:hover{ background:#f8fafc; }

    input[type="range"]{ width:100%; }

    .review{
      padding:14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#ffffff;
    }

    .review h3{ margin:0 0 10px; font-size:16px; }
    .review pre{
      margin:0;
      white-space:pre-wrap;
      word-wrap:break-word;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:13px;
      line-height:1.45;
      color:var(--text);
    }

    .toast{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#ffffff;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .toast.ok{ border-color:rgba(22,163,74,.30); }
    .toast.warn{ border-color:rgba(217,119,6,.30); }
    .toast.bad{ border-color:rgba(225,29,72,.28); }

    .dialpadWrap{ display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 900px){ .dialpadWrap{ grid-template-columns: 320px 1fr; } }

    .dialpad{
      border:1px solid var(--line);
      background:#ffffff;
      border-radius:16px;
      padding:12px;
    }

    .padGrid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }

    .padBtn{
      border-radius:14px;
      padding:14px 0;
      border:1px solid var(--line);
      background:#ffffff;
      color:var(--text);
      font-weight:750;
      font-size:16px;
    }
    .padBtn:hover{ background:#f8fafc; }

    .padBtn.filled{
      background:rgba(22,163,74,.10);
      border-color:rgba(22,163,74,.28);
    }
    .padBtn.partial{
      background:rgba(217,119,6,.10);
      border-color:rgba(217,119,6,.28);
    }

    .mapping{
      border:1px solid var(--line);
      background:#ffffff;
      border-radius:16px;
      padding:12px;
    }

    .mapRow{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:10px;
      align-items:start;
      padding:10px 0;
      border-bottom:1px solid #eef2f7;
    }
    .mapRow:last-child{ border-bottom:0; }

    .keycap{
      display:inline-flex;
      justify-content:center;
      align-items:center;
      width:100px;
      height:38px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#f8fafc;
      font-weight:800;
      color:var(--text);
    }

    .modal{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:999;
    }
    .modal.open{ display:flex; }

    .modalCard{
      width:min(950px, 100%);
      background:#ffffff;
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:0 30px 90px rgba(2,6,23,.28);
      overflow:hidden;
    }

    .modalHead{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--line);
      background:#ffffff;
      color:var(--text);
    }

    .modalBody{ padding:16px; background:#ffffff; }

    .twoCol{ display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; }
    @media (max-width: 860px){ .twoCol{ grid-template-columns: 1fr; } }

    .chart{
      border:1px solid var(--line);
      background:#ffffff;
      border-radius:16px;
      padding:12px;
      overflow:auto;
    }

    svg{ max-width:none; height:auto; }
    .flowNode{ fill:#ffffff; stroke:#cbd5e1; stroke-width:1; }
    .flowText{ fill:#0f172a; font: 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .flowLine{ stroke:#94a3b8; stroke-width:1.2; fill:none; }
    .flowArrow{ fill:#94a3b8; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="kicker">eTech Network Solutions</div>
      <h1>Call Flow Setup</h1>
    </header>

    <div class="card" id="wizard">
      <div class="topbar">
        <div class="progress" aria-label="Progress"><div id="progressFill"></div></div>
        <div class="stepcount" id="stepCount">Step 1 of 9</div>
      </div>

      <div class="body">
        <section class="q active" data-step="1">
          <h2>Main number</h2>
          <p>Enter the main number customers will call.</p>
          <div>
            <label for="mainNumber">Main phone number</label>
            <input id="mainNumber" type="tel" inputmode="numeric" placeholder="Digits only" autocomplete="tel" />
            <div class="hint">Example: 5125550123</div>
          </div>
        </section>

        <section class="q" data-step="2">
          <h2>Business hours</h2>
          <p>Select the days, then set open and close time for each selected day.</p>

          <div>
            <label>Days open</label>
            <div class="days" id="daysWrap"></div>
          </div>

          <div class="toast" style="margin-top:12px">Only checked days will show time sliders.</div>

          <div id="dayHoursWrap" style="margin-top:12px; display:grid; gap:12px"></div>

          <div class="toast warn" id="hoursWarn" style="display:none"></div>
        </section>

        <section class="q" data-step="3">
          <h2>During business hours</h2>
          <p>When someone calls the main number during open hours, what should happen?</p>
          <div class="choices" role="radiogroup" aria-label="Business hours behavior">
            <label class="choice">
              <input type="radio" name="bhMode" value="ring" />
              <div>
                <p class="ctitle">Ring people</p>
                <p class="csub">Caller hears ringing and a person or group answers.</p>
              </div>
            </label>
            <label class="choice">
              <input type="radio" name="bhMode" value="menu" />
              <div>
                <p class="ctitle">Play a greeting with options (menu)</p>
                <p class="csub">Caller selects options like 1 for Sales, 2 for Support.</p>
              </div>
            </label>
          </div>
        </section>

        <section class="q" data-step="4">
          <h2>Ring people details</h2>
          <p>Who should ring, and what should happen if nobody answers?</p>

          <div>
            <label for="ringList">Who should ring (extensions, one per line)</label>
            <textarea id="ringList" placeholder="Example:&#10;1000&#10;1001&#10;1005"></textarea>
          </div>

          <div style="margin-top:12px" class="grid">
            <div>
              <label for="ringNoAnswer">If no one answers, then</label>
              <select id="ringNoAnswer">
                <option value="">Select one</option>
                <option value="voicemail">Go to voicemail</option>
                <option value="another_group">Ring another group</option>
                <option value="menu">Go to a greeting with options (menu)</option>
              </select>
            </div>
            <div>
              <label for="ringSeconds">Ring time before no-answer action</label>
              <select id="ringSeconds">
                <option value="">Select one</option>
                <option value="20">20 seconds</option>
                <option value="30">30 seconds</option>
                <option value="45">45 seconds</option>
                <option value="60">60 seconds</option>
              </select>
            </div>
          </div>
        </section>

        <section class="q" data-step="5">
          <h2>No-answer handling</h2>
          <p>Set what happens after ringing if no one answers.</p>

          <div id="noAnswerBlock" class="hidden">
            <div id="noAnswerVoicemail" class="hidden">
              <label for="noAnswerVmBox">Whose voicemail box (extension)</label>
              <input id="noAnswerVmBox" type="text" placeholder="Example: 1000" inputmode="numeric" />
            </div>

            <div id="noAnswerGroup" class="hidden" style="margin-top:12px">
              <label for="noAnswerGroupExt">New group extension</label>
              <input id="noAnswerGroupExt" type="text" placeholder="Example: 2000" inputmode="numeric" />
            </div>

            <div id="noAnswerMenu" class="hidden" style="margin-top:12px">
              <label for="noAnswerMenuGreeting">Menu greeting wording</label>
              <textarea id="noAnswerMenuGreeting" placeholder='Example:&#10;"Sorry we missed you. Press 1 for Sales, Press 2 for Support."'></textarea>
              <div style="height:10px"></div>
              <div class="dialpadWrap">
                <div class="dialpad">
                  <div class="pill" style="margin-bottom:10px">Tap a key to add an option</div>
                  <div class="padGrid" id="padNoAnswer"></div>
                </div>
                <div class="mapping">
                  <div class="pill" style="margin-bottom:10px">Options routing (if it’s a group of extensions, separate with commas like 1000,1001)</div>
                  <div id="mapNoAnswer"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="toast warn" id="noAnswerWarn" style="display:none"></div>
        </section>

        <section class="q" data-step="6">
          <h2>Menu setup (business hours)</h2>
          <p>Write the greeting and build the options.</p>

          <div>
            <label for="bhMenuGreeting">Menu greeting wording</label>
            <textarea id="bhMenuGreeting" placeholder='Example:&#10;"Thank you for calling. Press 1 for Sales, Press 2 for Support."'></textarea>
          </div>

          <div style="height:10px"></div>

          <div class="dialpadWrap">
            <div class="dialpad">
              <div class="pill" style="margin-bottom:10px">Tap a key to add an option</div>
              <div class="padGrid" id="padBh"></div>
            </div>
            <div class="mapping">
              <div class="pill" style="margin-bottom:10px">Options routing (if it’s a group of extensions, separate with commas like 1000,1001)</div>
              <div id="mapBh"></div>
            </div>
          </div>
        </section>

        <section class="q" data-step="7">
          <h2>After hours</h2>
          <p>When someone calls after hours, what should happen?</p>
          <div class="choices" role="radiogroup" aria-label="After hours behavior">
            <label class="choice">
              <input type="radio" name="ahMode" value="voicemail" />
              <div>
                <p class="ctitle">Go to voicemail</p>
                <p class="csub">Play a closed message and then let them leave a voicemail.</p>
              </div>
            </label>
            <label class="choice">
              <input type="radio" name="ahMode" value="closed_menu" />
              <div>
                <p class="ctitle">Play a closed message with options (menu)</p>
                <p class="csub">Example: Press 1 for emergency, Press 2 for messages.</p>
              </div>
            </label>
            <label class="choice">
              <input type="radio" name="ahMode" value="forward" />
              <div>
                <p class="ctitle">Forward to a different number</p>
                <p class="csub">Send calls to a cell phone or answering service.</p>
              </div>
            </label>
          </div>
        </section>

        <section class="q" data-step="8">
          <h2>After hours details</h2>
          <p>Fill in the details for the option you selected.</p>

          <div id="ahDetails" class="hidden">
            <div id="ahVoicemail" class="hidden">
              <div class="grid">
                <div>
                  <label for="ahVmBox">Whose voicemail box (extension)</label>
                  <input id="ahVmBox" type="text" placeholder="Example: 1000" inputmode="numeric" />
                </div>
                <div>
                  <label for="ahVoice">Voice</label>
                  <select id="ahVoice">
                    <option value="">Select one</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                  </select>
                </div>
              </div>
              <div style="margin-top:12px">
                <label for="ahClosedMsg">Closed message wording</label>
                <textarea id="ahClosedMsg" placeholder='Example:&#10;"We’re currently closed. Please leave a message and we’ll call you back."'></textarea>
              </div>
            </div>

            <div id="ahClosedMenu" class="hidden">
              <div class="grid">
                <div>
                  <label for="ahMenuVoice">Voice</label>
                  <select id="ahMenuVoice">
                    <option value="">Select one</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                  </select>
                </div>
                <div>
                  <label for="ahMenuGreeting">Closed menu greeting wording</label>
                  <input id="ahMenuGreeting" type="text" placeholder="Example: We’re closed. Press 1 for emergency." />
                </div>
              </div>

              <div style="height:12px"></div>
              <div class="dialpadWrap">
                <div class="dialpad">
                  <div class="pill" style="margin-bottom:10px">Tap a key to add an option</div>
                  <div class="padGrid" id="padAh"></div>
                </div>
                <div class="mapping">
                  <div class="pill" style="margin-bottom:10px">Options routing (if it’s a group of extensions, separate with commas like 1000,1001)</div>
                  <div id="mapAh"></div>
                </div>
              </div>
            </div>

            <div id="ahForward" class="hidden">
              <label for="ahForwardNumber">Forward to this phone number</label>
              <input id="ahForwardNumber" type="tel" inputmode="numeric" placeholder="Digits only" />
            </div>
          </div>

          <div class="toast warn" id="ahWarn" style="display:none"></div>
        </section>

        <section class="q" data-step="review">
          <h2>Review</h2>
          <p><strong>Copy this and email your account manager.</strong></p>

          <div class="twoCol">
            <div>
              <div class="review">
                <h3>Summary</h3>
                <pre id="reviewText"></pre>
              </div>

              <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
                <button class="btn-primary" id="copyBtn" type="button">Copy summary</button>
                <button class="btn" id="printBtn" type="button">Print</button>
              </div>

              <div id="copyStatus" class="toast hidden"></div>
            </div>
            <div>
              <div class="chart">
                <div class="pill" style="margin-bottom:10px">Call tree preview</div>
                <div id="flowChart"></div>
              </div>
            </div>
          </div>
        </section>

        <div class="actions">
          <button class="btn" id="backBtn" type="button">Back</button>
          <div style="display:flex; gap:10px; align-items:center;">
            <span class="hint" id="miniHint">Use the buttons, not free-typing, where possible.</span>
            <button class="btn-primary" id="nextBtn" type="button">Next</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="confirmModal" role="dialog" aria-modal="true">
    <div class="modalCard">
      <div class="modalHead">
        <div style="font-weight:800">Confirm selections</div>
        <button class="btn" id="modalClose" type="button">Back</button>
      </div>
      <div class="modalBody">
        <div class="twoCol">
          <div class="review">
            <h3 style="margin:0 0 10px">What you chose</h3>
            <pre id="modalSummary"></pre>
          </div>
          <div class="toast ok">If this looks right, click Yes to continue.</div>
        </div>
        <div class="actions" style="margin-top:14px; border-top:1px solid var(--line)">
          <span class="hint">You can still change anything later using Back.</span>
          <div style="display:flex; gap:10px;">
            <button class="btn" id="modalNo" type="button">Not quite</button>
            <button class="btn-primary" id="modalYes" type="button">Yes</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const steps = Array.from(document.querySelectorAll('.q[data-step]'));
    const progressFill = document.getElementById('progressFill');
    const stepCount = document.getElementById('stepCount');
    const backBtn = document.getElementById('backBtn');
    const nextBtn = document.getElementById('nextBtn');
    const miniHint = document.getElementById('miniHint');

    const mainNumber = document.getElementById('mainNumber');

    const daysWrap = document.getElementById('daysWrap');
    const dayHoursWrap = document.getElementById('dayHoursWrap');
    const hoursWarn = document.getElementById('hoursWarn');

    const ringList = document.getElementById('ringList');
    const ringNoAnswer = document.getElementById('ringNoAnswer');
    const ringSeconds = document.getElementById('ringSeconds');

    const noAnswerBlock = document.getElementById('noAnswerBlock');
    const noAnswerVoicemail = document.getElementById('noAnswerVoicemail');
    const noAnswerGroup = document.getElementById('noAnswerGroup');
    const noAnswerMenu = document.getElementById('noAnswerMenu');
    const noAnswerVmBox = document.getElementById('noAnswerVmBox');
    const noAnswerGroupExt = document.getElementById('noAnswerGroupExt');
    const noAnswerMenuGreeting = document.getElementById('noAnswerMenuGreeting');
    const noAnswerWarn = document.getElementById('noAnswerWarn');

    const bhMenuGreeting = document.getElementById('bhMenuGreeting');

    const ahDetails = document.getElementById('ahDetails');
    const ahVoicemail = document.getElementById('ahVoicemail');
    const ahClosedMenu = document.getElementById('ahClosedMenu');
    const ahForward = document.getElementById('ahForward');
    const ahVmBox = document.getElementById('ahVmBox');
    const ahVoice = document.getElementById('ahVoice');
    const ahClosedMsg = document.getElementById('ahClosedMsg');
    const ahMenuVoice = document.getElementById('ahMenuVoice');
    const ahMenuGreeting = document.getElementById('ahMenuGreeting');
    const ahForwardNumber = document.getElementById('ahForwardNumber');
    const ahWarn = document.getElementById('ahWarn');

    const reviewText = document.getElementById('reviewText');
    const flowChart = document.getElementById('flowChart');

    const copyBtn = document.getElementById('copyBtn');
    const printBtn = document.getElementById('printBtn');
    const copyStatus = document.getElementById('copyStatus');

    const confirmModal = document.getElementById('confirmModal');
    const modalSummary = document.getElementById('modalSummary');
    const modalClose = document.getElementById('modalClose');
    const modalNo = document.getElementById('modalNo');
    const modalYes = document.getElementById('modalYes');

    const dayLabels = [
      { key:'mon', label:'Mon' },
      { key:'tue', label:'Tue' },
      { key:'wed', label:'Wed' },
      { key:'thu', label:'Thu' },
      { key:'fri', label:'Fri' },
      { key:'sat', label:'Sat' },
      { key:'sun', label:'Sun' }
    ];

    const dialKeys = ['1','2','3','4','5','6','7','8','9','*','0','#'];

    const state = {
      mainNumber: '',
      daysOpen: new Set(),
      dayHours: {
        mon: { open: 32, close: 68 },
        tue: { open: 32, close: 68 },
        wed: { open: 32, close: 68 },
        thu: { open: 32, close: 68 },
        fri: { open: 32, close: 68 },
        sat: { open: 32, close: 68 },
        sun: { open: 32, close: 68 }
      },
      bhMode: '',
      ringList: '',
      ringSeconds: '',
      ringNoAnswer: '',
      noAnswer: { vmBox:'', groupExt:'', menuGreeting:'', menuMap:{} },
      bhMenu: { greeting:'', map:{} },
      ahMode: '',
      afterHours: { vmBox:'', closedMsg:'', voice:'', menuVoice:'', menuGreeting:'', menuMap:{}, forwardNumber:'' }
    };

    const dial = {
      bh: { padId:'padBh', mapId:'mapBh', store: state.bhMenu.map },
      no: { padId:'padNoAnswer', mapId:'mapNoAnswer', store: state.noAnswer.menuMap },
      ah: { padId:'padAh', mapId:'mapAh', store: state.afterHours.menuMap }
    };

    let index = 0;
    let modalContinue = null;

    function qs(name){ return document.querySelector(`[name="${name}"]:checked`); }
    function idxOf(stepVal){ return steps.findIndex(s => s.dataset.step === String(stepVal)); }
    function clamp(n,min,max){ return Math.min(Math.max(n,min),max); }

    function digitsOnly(s){ return (s || '').replace(/\D/g,''); }

    function sanitizeExtensionsList(raw){
      let s = String(raw || '');
      s = s.replace(/\s+/g,'');
      s = s.replace(/[^0-9,]/g,'');
      s = s.replace(/,{2,}/g,',');
      s = s.replace(/^,|,$/g,'');
      if (!s) return '';
      const parts = s.split(',').filter(p => p.length > 0).map(p => p.slice(0,5));
      return parts.join(',');
    }

    function slotToTime(slot){
      const totalMins = slot * 15;
      let h = Math.floor(totalMins / 60);
      const m = totalMins % 60;
      const ampm = h >= 12 ? 'PM' : 'AM';
      h = h % 12;
      if (h === 0) h = 12;
      const mm = String(m).padStart(2,'0');
      return `${h}:${mm} ${ampm}`;
    }

    function renderDays(){
      daysWrap.innerHTML = '';
      for (const d of dayLabels){
        const lbl = document.createElement('label');
        lbl.className = 'day';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = state.daysOpen.has(d.key);
        cb.addEventListener('change', () => {
          if (cb.checked) state.daysOpen.add(d.key);
          else state.daysOpen.delete(d.key);
          renderDayHours();      // <-- per-day slider generation happens here
          validateHours();
        });
        const span = document.createElement('span');
        span.textContent = d.label;
        lbl.appendChild(cb);
        lbl.appendChild(span);
        daysWrap.appendChild(lbl);
      }
    }

    function normalizeDaySlots(dayKey){
      const minGap = 1;
      if (state.dayHours[dayKey].close <= state.dayHours[dayKey].open + minGap) {
        state.dayHours[dayKey].close = clamp(state.dayHours[dayKey].open + minGap, 0, 95);
      }
    }

    function updateDayPill(dayKey){
      const el = document.getElementById(`pill_${dayKey}`);
      if (!el) return;
      el.textContent = `${slotToTime(state.dayHours[dayKey].open)} – ${slotToTime(state.dayHours[dayKey].close)}`;
    }

    function renderDayHours(){
      dayHoursWrap.innerHTML = '';
      const selected = dayLabels.filter(d => state.daysOpen.has(d.key));
      if (selected.length === 0) return;

      for (const d of selected){
        const card = document.createElement('div');
        card.style.border = '1px solid var(--line)';
        card.style.borderRadius = '16px';
        card.style.background = '#ffffff';
        card.style.padding = '12px';

        const head = document.createElement('div');
        head.className = 'row';
        head.style.justifyContent = 'space-between';

        const title = document.createElement('div');
        title.style.fontWeight = '800';
        title.textContent = d.label;

        const pill = document.createElement('div');
        pill.className = 'pill';
        pill.id = `pill_${d.key}`;

        head.appendChild(title);
        head.appendChild(pill);

        const grid = document.createElement('div');
        grid.className = 'grid';
        grid.style.marginTop = '10px';

        const left = document.createElement('div');
        const lLabel = document.createElement('label');
        lLabel.textContent = 'Open time';
        const lRange = document.createElement('input');
        lRange.type = 'range';
        lRange.min = '0';
        lRange.max = '95';
        lRange.step = '1';
        lRange.value = String(state.dayHours[d.key].open);

        const right = document.createElement('div');
        const rLabel = document.createElement('label');
        rLabel.textContent = 'Close time';
        const rRange = document.createElement('input');
        rRange.type = 'range';
        rRange.min = '0';
        rRange.max = '95';
        rRange.step = '1';
        rRange.value = String(state.dayHours[d.key].close);

        const update = () => {
          state.dayHours[d.key].open = Number(lRange.value);
          state.dayHours[d.key].close = Number(rRange.value);
          normalizeDaySlots(d.key);
          rRange.value = String(state.dayHours[d.key].close);
          updateDayPill(d.key);
          validateHours();
        };

        lRange.addEventListener('input', update);
        rRange.addEventListener('input', update);

        left.appendChild(lLabel);
        left.appendChild(lRange);

        right.appendChild(rLabel);
        right.appendChild(rRange);

        grid.appendChild(left);
        grid.appendChild(right);

        card.appendChild(head);
        card.appendChild(grid);
        dayHoursWrap.appendChild(card);

        updateDayPill(d.key);
      }
    }

    function validateHours(){
      if (state.daysOpen.size === 0) {
        hoursWarn.style.display = 'block';
        hoursWarn.textContent = 'Choose at least one day.';
        return false;
      }
      for (const d of dayLabels){
        if (!state.daysOpen.has(d.key)) continue;
        const o = state.dayHours[d.key].open;
        const c = state.dayHours[d.key].close;
        if (c <= o) {
          hoursWarn.style.display = 'block';
          hoursWarn.textContent = `Close time must be after open time for ${d.label}.`;
          return false;
        }
      }
      hoursWarn.style.display = 'none';
      hoursWarn.textContent = '';
      return true;
    }

    function getBhMode(){ return qs('bhMode')?.value || ''; }
    function getAhMode(){ return qs('ahMode')?.value || ''; }

    function setNoAnswerUI(){
      const v = ringNoAnswer.value;
      state.ringNoAnswer = v;
      noAnswerBlock.classList.toggle('hidden', !v);
      noAnswerVoicemail.classList.toggle('hidden', v !== 'voicemail');
      noAnswerGroup.classList.toggle('hidden', v !== 'another_group');
      noAnswerMenu.classList.toggle('hidden', v !== 'menu');
      noAnswerWarn.style.display = 'none';
      noAnswerWarn.textContent = '';
    }

    function setAfterHoursUI(){
      const v = getAhMode();
      state.ahMode = v;
      ahDetails.classList.toggle('hidden', !v);
      ahVoicemail.classList.toggle('hidden', v !== 'voicemail');
      ahClosedMenu.classList.toggle('hidden', v !== 'closed_menu');
      ahForward.classList.toggle('hidden', v !== 'forward');
      ahWarn.style.display = 'none';
      ahWarn.textContent = '';
    }

    function cssEscapeAttr(s){ return String(s).replace(/"/g,'\\"'); }

    function renderDial(which){
      const cfg = dial[which];
      const pad = document.getElementById(cfg.padId);
      const map = document.getElementById(cfg.mapId);
      pad.innerHTML = '';
      map.innerHTML = '';

      for (const k of dialKeys){
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'padBtn';
        b.textContent = k;
        b.dataset.key = k;

        const val = String(cfg.store[k] ?? '').trim();
        if (val) b.classList.add('filled');

        b.addEventListener('click', () => {
          if (!Object.prototype.hasOwnProperty.call(cfg.store, k)) cfg.store[k] = '';
          renderDial(which);
          const input = map.querySelector(`input[data-key="${cssEscapeAttr(k)}"]`);
          if (input) input.focus();
        });

        pad.appendChild(b);
      }

      const keys = Object.keys(cfg.store);
      for (const k of keys){
        const row = document.createElement('div');
        row.className = 'mapRow';

        const left = document.createElement('div');
        const cap = document.createElement('div');
        cap.className = 'keycap';
        cap.textContent = k === '*' ? 'Star (*)' : k === '#' ? 'Pound (#)' : `Press ${k}`;
        left.appendChild(cap);

        const right = document.createElement('div');
        const input = document.createElement('input');
        input.type = 'text';
        input.inputMode = 'numeric';
        input.placeholder = 'Extensions (comma separated)';
        input.value = String(cfg.store[k] ?? '');
        input.dataset.key = k;

        input.addEventListener('input', () => {
          input.value = sanitizeExtensionsList(input.value);
          cfg.store[k] = input.value;
          renderDial(which);
        });

        const remove = document.createElement('button');
        remove.type = 'button';
        remove.className = 'btn';
        remove.style.marginTop = '10px';
        remove.textContent = 'Remove option';
        remove.addEventListener('click', () => {
          delete cfg.store[k];
          renderDial(which);
        });

        right.appendChild(input);
        right.appendChild(remove);

        row.appendChild(left);
        row.appendChild(right);
        map.appendChild(row);
      }

      const padBtns = pad.querySelectorAll('.padBtn');
      for (const pb of padBtns){
        const k = pb.dataset.key;
        const exists = Object.prototype.hasOwnProperty.call(cfg.store, k);
        const val = String(cfg.store[k] ?? '').trim();
        pb.classList.toggle('partial', exists && !val);
        pb.classList.toggle('filled', !!val);
      }
    }

    function collect(){
      state.mainNumber = digitsOnly(mainNumber.value);
      mainNumber.value = state.mainNumber;

      state.bhMode = getBhMode();
      state.ringList = (ringList.value || '').trim();
      state.ringSeconds = ringSeconds.value;
      state.ringNoAnswer = ringNoAnswer.value;

      state.noAnswer.vmBox = digitsOnly(noAnswerVmBox.value);
      noAnswerVmBox.value = state.noAnswer.vmBox;
      state.noAnswer.groupExt = digitsOnly(noAnswerGroupExt.value);
      noAnswerGroupExt.value = state.noAnswer.groupExt;
      state.noAnswer.menuGreeting = (noAnswerMenuGreeting.value || '').trim();

      state.bhMenu.greeting = (bhMenuGreeting.value || '').trim();

      state.ahMode = getAhMode();
      state.afterHours.vmBox = digitsOnly(ahVmBox.value);
      ahVmBox.value = state.afterHours.vmBox;
      state.afterHours.voice = ahVoice.value;
      state.afterHours.closedMsg = (ahClosedMsg.value || '').trim();

      state.afterHours.menuVoice = ahMenuVoice.value;
      state.afterHours.menuGreeting = (ahMenuGreeting.value || '').trim();

      state.afterHours.forwardNumber = digitsOnly(ahForwardNumber.value);
      ahForwardNumber.value = state.afterHours.forwardNumber;
    }

    function anyDialHasEntries(mapObj){
      const keys = Object.keys(mapObj);
      if (keys.length === 0) return false;
      return keys.some(k => String(mapObj[k] ?? '').trim().length > 0);
    }

    function dialSummary(title, greeting, mapObj){
      const lines = [];
      lines.push(title);
      if (greeting) lines.push(`  Greeting: ${greeting}`);
      const keys = Object.keys(mapObj).sort((a,b) => dialKeys.indexOf(a) - dialKeys.indexOf(b));
      if (keys.length === 0) lines.push('  Options: [none]');
      else {
        lines.push('  Options:');
        for (const k of keys){
          const v = String(mapObj[k] ?? '').trim();
          const label = k === '*' ? 'Star (*)' : k === '#' ? 'Pound (#)' : k;
          lines.push(`    ${label} -> ${v || '[not set]'}`);
        }
      }
      return lines.join('\n');
    }

    function openConfirm(summaryText, onYes){
      modalSummary.textContent = summaryText;
      confirmModal.classList.add('open');
      modalContinue = onYes;
    }

    function closeConfirm(){
      confirmModal.classList.remove('open');
      modalContinue = null;
    }

    function showWarn(el, msg){ el.style.display = 'block'; el.textContent = msg; }
    function hideWarn(el){ el.style.display = 'none'; el.textContent = ''; }

    function setHint(msg){
      if (msg) {
        miniHint.textContent = msg;
        miniHint.style.color = '#b45309';
      } else {
        miniHint.textContent = 'Use the buttons, not free-typing, where possible.';
        miniHint.style.color = '';
      }
    }

    function validateStep(stepVal){
      if (stepVal === '1'){
        const n = digitsOnly(mainNumber.value);
        if (n.length < 10) { setHint('Enter a valid main number (at least 10 digits).'); return false; }
        setHint('');
        return true;
      }

      if (stepVal === '2'){
        if (!validateHours()) { setHint('Fix business hours before continuing.'); return false; }
        setHint('');
        return true;
      }

      if (stepVal === '3'){
        const mode = getBhMode();
        if (!mode) { setHint('Choose Ring people or Greeting with options.'); return false; }
        setHint('');
        return true;
      }

      if (stepVal === '4'){
        if (getBhMode() !== 'ring') return true;
        if (!(state.ringList || '').trim()) { setHint('Enter at least one extension to ring.'); return false; }
        if (!ringSeconds.value) { setHint('Choose a ring time.'); return false; }
        if (!ringNoAnswer.value) { setHint('Choose what happens if no one answers.'); return false; }
        setHint('');
        return true;
      }

      if (stepVal === '5'){
        if (getBhMode() !== 'ring') return true;
        const action = ringNoAnswer.value;
        if (!action) return true;

        if (action === 'voicemail'){
          const vm = digitsOnly(noAnswerVmBox.value);
          if (!vm) { showWarn(noAnswerWarn, 'Enter whose voicemail box (extension).'); return false; }
        }
        if (action === 'another_group'){
          const g = digitsOnly(noAnswerGroupExt.value);
          if (!g) { showWarn(noAnswerWarn, 'Enter the new group extension.'); return false; }
        }
        if (action === 'menu'){
          const greet = (noAnswerMenuGreeting.value || '').trim();
          if (!greet) { showWarn(noAnswerWarn, 'Enter the menu greeting wording.'); return false; }
          if (!anyDialHasEntries(state.noAnswer.menuMap)) { showWarn(noAnswerWarn, 'Add at least one menu option and set its routing.'); return false; }
        }

        hideWarn(noAnswerWarn);
        setHint('');
        return true;
      }

      if (stepVal === '6'){
        if (getBhMode() !== 'menu') return true;
        const greet = (bhMenuGreeting.value || '').trim();
        if (!greet) { setHint('Enter the menu greeting wording.'); return false; }
        if (!anyDialHasEntries(state.bhMenu.map)) { setHint('Add at least one menu option and set its routing.'); return false; }
        setHint('');
        return true;
      }

      if (stepVal === '7'){
        const v = getAhMode();
        if (!v) { setHint('Choose an after-hours option.'); return false; }
        setHint('');
        return true;
      }

      if (stepVal === '8'){
        const v = getAhMode();
        if (!v) return true;

        if (v === 'voicemail'){
          if (!digitsOnly(ahVmBox.value)) { showWarn(ahWarn, 'Enter whose voicemail box (extension).'); return false; }
          if (!ahVoice.value) { showWarn(ahWarn, 'Choose a voice (male or female).'); return false; }
          if (!(ahClosedMsg.value || '').trim()) { showWarn(ahWarn, 'Enter what the closed message should say.'); return false; }
        }

        if (v === 'closed_menu'){
          if (!ahMenuVoice.value) { showWarn(ahWarn, 'Choose a voice (male or female).'); return false; }
          if (!(ahMenuGreeting.value || '').trim()) { showWarn(ahWarn, 'Enter the closed menu greeting.'); return false; }
          if (!anyDialHasEntries(state.afterHours.menuMap)) { showWarn(ahWarn, 'Add at least one menu option and set its routing.'); return false; }
        }

        if (v === 'forward'){
          const f = digitsOnly(ahForwardNumber.value);
          if (f.length < 10) { showWarn(ahWarn, 'Enter a valid forward number (at least 10 digits).'); return false; }
        }

        hideWarn(ahWarn);
        setHint('');
        return true;
      }

      return true;
    }

    function showStep(i){
      steps.forEach(s => s.classList.remove('active'));
      steps[i].classList.add('active');

      const total = 9;
      const current = (steps[i].dataset.step === 'review') ? 9 : Number(steps[i].dataset.step);
      stepCount.textContent = `Step ${current} of ${total}`;
      progressFill.style.width = `${(current/total)*100}%`;

      backBtn.disabled = (i === 0);
      backBtn.style.opacity = backBtn.disabled ? 0.5 : 1;

      nextBtn.textContent = (steps[i].dataset.step === 'review') ? 'Done' : 'Next';

      setHint(steps[i].dataset.step === 'review' ? 'Copy the summary and email it to your account manager.' : '');
    }

    function getNextIndex(currentIndex){
      const stepVal = steps[currentIndex]?.dataset.step;
      if (stepVal === '3'){
        const mode = getBhMode();
        if (mode === 'ring') return idxOf('4');
        if (mode === 'menu') return idxOf('6');
        return idxOf('4');
      }
      if (stepVal === '4') return idxOf('5');
      if (stepVal === '5') return idxOf('7');
      if (stepVal === '6') return idxOf('7');
      if (stepVal === '7') return idxOf('8');
      if (stepVal === '8') return idxOf('review');
      return Math.min(currentIndex + 1, steps.length - 1);
    }

    function getPrevIndex(currentIndex){
      const stepVal = steps[currentIndex]?.dataset.step;
      if (stepVal === '4') return idxOf('3');
      if (stepVal === '5') return idxOf('4');
      if (stepVal === '6') return idxOf('3');
      if (stepVal === '7') return getBhMode() === 'menu' ? idxOf('6') : idxOf('5');
      if (stepVal === '8') return idxOf('7');
      if (stepVal === 'review') return idxOf('8');
      return Math.max(currentIndex - 1, 0);
    }

    function formatNoAnswerLabel(v){
      if (v === 'voicemail') return 'Go to voicemail';
      if (v === 'another_group') return 'Ring another group';
      if (v === 'menu') return 'Go to a menu';
      return '[not set]';
    }

    function indentBlock(text, spaces){
      const pad = ' '.repeat(spaces);
      return String(text).split('\n').map(l => pad + l).join('\n');
    }

    function buildReview(){
      const lines = [];

      lines.push(`Main Number: ${state.mainNumber || '[not provided]'}`);
      lines.push('');

      lines.push('Business Hours');
      const selected = dayLabels.filter(d => state.daysOpen.has(d.key));
      if (selected.length === 0) lines.push('  Days: [none]');
      else {
        for (const d of selected){
          lines.push(`  ${d.label}: ${slotToTime(state.dayHours[d.key].open)} – ${slotToTime(state.dayHours[d.key].close)}`);
        }
      }
      lines.push('');

      lines.push('During Business Hours (Main Number)');
      if (state.bhMode === 'ring') {
        lines.push('  Mode: Ring people');
        lines.push(`  Ring time: ${state.ringSeconds || '[not set]'} seconds`);
        lines.push('  Ring list:');
        lines.push(indentBlock(state.ringList || '[not provided]', 4));
        lines.push(`  If no one answers: ${formatNoAnswerLabel(state.ringNoAnswer)}`);
        if (state.ringNoAnswer === 'voicemail') lines.push(`  Voicemail box: ${state.noAnswer.vmBox || '[not set]'}`);
        if (state.ringNoAnswer === 'another_group') lines.push(`  Second group extension: ${state.noAnswer.groupExt || '[not set]'}`);
        if (state.ringNoAnswer === 'menu') lines.push(dialSummary('  No-answer menu', state.noAnswer.menuGreeting, state.noAnswer.menuMap).split('\n').map(x => '  ' + x).join('\n'));
      }
      if (state.bhMode === 'menu') {
        lines.push('  Mode: Greeting with options');
        lines.push(dialSummary('  Business-hours menu', state.bhMenu.greeting, state.bhMenu.map));
      }
      lines.push('');

      lines.push('After Hours (Main Number)');
      if (state.ahMode === 'voicemail'){
        lines.push('  Mode: Voicemail');
        lines.push(`  Voicemail box: ${state.afterHours.vmBox || '[not set]'}`);
        lines.push(`  Voice: ${state.afterHours.voice || '[not set]'}`);
        lines.push('  Closed message:');
        lines.push(indentBlock(state.afterHours.closedMsg || '[not set]', 4));
      }
      if (state.ahMode === 'closed_menu'){
        lines.push('  Mode: Closed message with options');
        lines.push(`  Voice: ${state.afterHours.menuVoice || '[not set]'}`);
        lines.push(dialSummary('  After-hours menu', state.afterHours.menuGreeting, state.afterHours.menuMap));
      }
      if (state.ahMode === 'forward'){
        lines.push('  Mode: Forward');
        lines.push(`  Forward number: ${state.afterHours.forwardNumber || '[not set]'}`);
      }

      reviewText.textContent = lines.join('\n');
      flowChart.innerHTML = buildFlowSvg();
    }

    function buildFlowSvg(){
      const nodes = [];
      const edges = [];

      const addNode = (id, label, x, y, w=280, h=70) => { nodes.push({ id, label, x, y, w, h }); };
      const addEdge = (from, to, label='') => { edges.push({ from, to, label }); };

      let y0 = 30;
      addNode('n0', `Main Number\n${state.mainNumber || ''}`, 30, y0);
      addNode('n1', 'Business Hours\nVaries by day', 30, y0 + 110);
      addEdge('n0','n1','');

      addNode('n2', 'During Business Hours', 360, y0 + 110);
      addEdge('n1','n2','open');

      addNode('n3', 'After Hours', 360, y0 + 300);
      addEdge('n1','n3','closed');

      if (state.bhMode === 'ring'){
        addNode('n4', 'Ring Group', 690, y0 + 110);
        addEdge('n2','n4', `${state.ringSeconds || ''}s ring`);
      } else if (state.bhMode === 'menu'){
        addNode('n4', 'Business-hours Menu', 690, y0 + 110);
        addEdge('n2','n4','');
      } else {
        addNode('n4', 'Business-hours (not set)', 690, y0 + 110);
        addEdge('n2','n4','');
      }

      if (state.ahMode === 'voicemail'){
        addNode('a1', 'Closed Message', 690, y0 + 300);
        addEdge('n3','a1','');
        addNode('a2', `Voicemail Box\n${state.afterHours.vmBox || ''}`, 1020, y0 + 300);
        addEdge('a1','a2','');
      } else if (state.ahMode === 'closed_menu'){
        addNode('a1', 'After-hours Menu', 690, y0 + 300);
        addEdge('n3','a1','');
      } else if (state.ahMode === 'forward'){
        addNode('a1', `Forward\n${state.afterHours.forwardNumber || ''}`, 690, y0 + 300);
        addEdge('n3','a1','');
      } else {
        addNode('a1', 'After-hours (not set)', 690, y0 + 300);
        addEdge('n3','a1','');
      }

      const maxX = 1500;
      const maxY = 700;

      const nodeById = Object.fromEntries(nodes.map(n => [n.id, n]));

      const arrow = (x, y, angle) => {
        const size = 8;
        const pts = `0,0 ${-size},${size/2} ${-size},${-size/2}`;
        return `<g transform="translate(${x},${y}) rotate(${angle})"><polygon class="flowArrow" points="${pts}"></polygon></g>`;
      };

      const line = (x1,y1,x2,y2) => `<path class="flowLine" d="M ${x1} ${y1} L ${x2} ${y2}"></path>`;
      const label = (x,y,t) => t ? `<text class="flowText" x="${x}" y="${y}" text-anchor="middle" opacity="0.85">${escapeXml(t)}</text>` : '';

      const wrapLabel = (s, maxLen=28) => {
        const words = String(s).replace(/\n/g,' ').split(/\s+/).filter(Boolean);
        const out = [];
        let cur = '';
        for (const w of words){
          const next = (cur ? cur + ' ' : '') + w;
          if (next.length <= maxLen) cur = next;
          else { if (cur) out.push(cur); cur = w; }
        }
        if (cur) out.push(cur);
        return out.slice(0,4);
      };

      const svgNodes = nodes.map(n => {
        const lines = wrapLabel(n.label);
        const cx = n.x + n.w/2;
        const baseY = n.y + 24;
        const tspans = lines.map((ln, i) => `<tspan x="${cx}" dy="${i===0?0:14}">${escapeXml(ln)}</tspan>`).join('');
        return `<g><rect class="flowNode" x="${n.x}" y="${n.y}" width="${n.w}" height="${n.h}" rx="14"></rect><text class="flowText" x="${cx}" y="${baseY}" text-anchor="middle">${tspans}</text></g>`;
      }).join('');

      const svgEdges = edges.map(e => {
        const a = nodeById[e.from];
        const b = nodeById[e.to];
        if (!a || !b) return '';
        const x1 = a.x + a.w;
        const y1 = a.y + a.h/2;
        const x2 = b.x;
        const y2 = b.y + b.h/2;
        const mx = (x1 + x2) / 2;
        const my = (y1 + y2) / 2 - 8;
        const ang = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
        return `${line(x1,y1,x2,y2)}${arrow(x2,y2,ang)}${label(mx,my,e.label)}`;
      }).join('');

      return `<svg viewBox="0 0 ${maxX} ${maxY}" width="1800" height="900" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Call flow diagram" style="min-width:1600px">${svgEdges}${svgNodes}</svg>`;
    }

    function escapeXml(s){
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    function menuConfirmText(which){
      if (which === 'bh') return dialSummary('Business-hours Menu', (bhMenuGreeting.value || '').trim(), state.bhMenu.map);
      if (which === 'no') return dialSummary('No-answer Menu', (noAnswerMenuGreeting.value || '').trim(), state.noAnswer.menuMap);
      if (which === 'ah') return dialSummary('After-hours Menu', (ahMenuGreeting.value || '').trim(), state.afterHours.menuMap);
      return '';
    }

    function maybeConfirmMenus(stepVal, onContinue){
      if (stepVal === '5' && ringNoAnswer.value === 'menu') { openConfirm(menuConfirmText('no'), onContinue); return true; }
      if (stepVal === '6') { openConfirm(menuConfirmText('bh'), onContinue); return true; }
      if (stepVal === '8' && getAhMode() === 'closed_menu') { openConfirm(menuConfirmText('ah'), onContinue); return true; }
      return false;
    }

    function setCopyStatus(msg, kind='ok'){
      copyStatus.classList.remove('hidden');
      copyStatus.classList.remove('ok','warn','bad');
      copyStatus.classList.add(kind);
      copyStatus.textContent = msg;
    }

    mainNumber.addEventListener('input', () => { mainNumber.value = digitsOnly(mainNumber.value); });
    ringNoAnswer.addEventListener('change', () => setNoAnswerUI());

    document.addEventListener('change', (e) => {
      if (e.target && e.target.name === 'ahMode') setAfterHoursUI();
    });

    modalClose.addEventListener('click', () => closeConfirm());
    modalNo.addEventListener('click', () => closeConfirm());
    modalYes.addEventListener('click', () => {
      const fn = modalContinue;
      closeConfirm();
      if (typeof fn === 'function') fn();
    });

    nextBtn.addEventListener('click', () => {
      collect();
      const stepVal = steps[index].dataset.step;
      if (stepVal === 'review') return;
      if (!validateStep(stepVal)) return;

      const go = () => {
        const next = getNextIndex(index);
        index = clamp(next, 0, steps.length - 1);
        if (steps[index].dataset.step === 'review'){
          collect();
          buildReview();
          copyStatus.classList.add('hidden');
        }
        showStep(index);
      };

      if (maybeConfirmMenus(stepVal, go)) return;
      go();
    });

    backBtn.addEventListener('click', () => {
      collect();
      const prev = getPrevIndex(index);
      index = clamp(prev, 0, steps.length - 1);
      showStep(index);
    });

    copyBtn?.addEventListener('click', async () => {
      collect();
      buildReview();
      const text = reviewText.textContent || '';
      if (!text.trim()) { setCopyStatus('Nothing to copy yet.', 'warn'); return; }
      try {
        await navigator.clipboard.writeText(text);
        setCopyStatus('Copied. Paste it into an email to your account manager.','ok');
      } catch {
        setCopyStatus('Couldn’t auto-copy. Select the text and copy it manually.','warn');
      }
    });

    printBtn?.addEventListener('click', () => {
      collect();
      buildReview();
      window.print();
    });

    function init(){
      renderDays();
      renderDayHours();
      validateHours();

      renderDial('bh');
      renderDial('no');
      renderDial('ah');

      setNoAnswerUI();
      setAfterHoursUI();

      showStep(index);
    }

    init();
  </script>
</body>
</html>
</em>